<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trio Manager Ultimate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- PREMIUM DEĞİŞKENLER --- */
        :root {
            --primary: #4f46e5; /* İndigo Mavisi */
            --primary-dark: #4338ca;
            --secondary: #ec4899; /* Modern Pembe */
            --bg-body: #F3F4F6; /* Çok açık gri (Apple stili) */
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius-L: 24px;
            --radius-M: 16px;
            --radius-S: 12px;
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --glass: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
        }

        body.dark-mode {
            --bg-body: #0f172a;
            --surface: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border: #334155;
            --glass: rgba(30, 41, 59, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.05);
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            padding-bottom: 110px; 
            padding-top: env(safe-area-inset-top);
            transition: background-color 0.4s ease;
        }

        .app-container { max-width: 600px; margin: 0 auto; padding: 20px; display: none; }

        /* --- LOGO & HEADER (Glassmorphism) --- */
        .header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;
            padding: 15px 0;
        }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo-box {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 22px;
            box-shadow: 0 8px 16px -4px rgba(79, 70, 229, 0.4);
        }
        .brand h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; line-height: 1.1; }
        .brand h1 span { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }

        .btn-icon-glass {
            width: 44px; height: 44px;
            border-radius: 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-card);
        }
        .btn-icon-glass:active { transform: scale(0.92); }

        /* --- DASHBOARD WIDGETS --- */
        .stats { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 30px; 
        }
        .stat-item { 
            background: var(--surface); 
            padding: 15px 5px; 
            border-radius: 20px; 
            text-align: center; 
            border: 1px solid var(--border);
            box-shadow: var(--shadow-card);
            transition: transform 0.2s;
        }
        .stat-item:active { transform: scale(0.95); }
        .stat-val { font-size: 22px; font-weight: 800; display: block; margin-bottom: 4px; background: linear-gradient(to right, var(--text-main), var(--text-sub)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-lbl { font-size: 9px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- ARAMA & FİLTRE --- */
        .search-wrapper { 
            background: var(--surface); 
            padding: 8px 8px 8px 16px; 
            border-radius: 18px; 
            display: flex; align-items: center; 
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .search-wrapper i { color: var(--text-sub); margin-right: 10px; }
        .form-input-clean { border: none; background: transparent; width: 100%; height: 100%; outline: none; font-size: 15px; font-weight: 500; color: var(--text-main); }
        
        .filter-scroll { 
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; 
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .filter-scroll::-webkit-scrollbar { display: none; }
        
        .filter-chip { 
            padding: 10px 20px; 
            border-radius: 30px; 
            border: 1px solid var(--border); 
            background: var(--surface); 
            color: var(--text-sub); 
            font-size: 13px; font-weight: 600; 
            white-space: nowrap; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .filter-chip span { font-weight: 800; margin-left: 5px; opacity: 0.6; font-size: 11px; }
        .filter-chip.active { 
            background: var(--text-main); 
            color: var(--surface); 
            border-color: var(--text-main); 
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* --- MODERN KARTLAR --- */
        .card {
            background: var(--surface);
            border-radius: var(--radius-L);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
            animation: slideIn 0.4s ease forwards;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Kart Kenar Çizgisi Yerine Pill Badge */
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
        .card-sub { font-size: 13px; color: var(--text-sub); display: flex; align-items: center; gap: 6px; }
        
        .status-pill { 
            font-size: 10px; font-weight: 800; padding: 6px 12px; border-radius: 20px; letter-spacing: 0.5px;
        }
        .sp-green { background: rgba(16, 185, 129, 0.1); color: #059669; }
        .sp-red { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
        .sp-orange { background: rgba(245, 158, 11, 0.1); color: #d97706; }
        .sp-blue { background: rgba(79, 70, 229, 0.1); color: #4f46e5; }
        
        .c-actions { 
            display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; 
            border-top: 1px dashed var(--border);
            overflow-x: auto;
        }
        
        .btn-act { 
            flex: 1; min-width: max-content; height: 42px; 
            border-radius: 12px; border: none; 
            font-size: 12px; font-weight: 700; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 6px; 
            padding: 0 16px; transition: 0.2s;
        }
        .btn-act:active { transform: scale(0.96); }
        .btn-act.primary { background: var(--text-main); color: var(--surface); }
        .btn-act.soft { background: var(--bg-body); color: var(--text-main); }
        .btn-act.danger { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
        .btn-act.whatsapp { background: #dcfce7; color: #15803d; }

        /* --- TAB BAR (FLOATING) --- */
        .tab-bar { 
            position: fixed; bottom: 20px; left: 20px; right: 20px; 
            background: var(--glass); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: var(--glass-border);
            border-radius: 30px; 
            display: flex; justify-content: space-around; padding: 12px; 
            z-index: 100; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            max-width: 560px; margin: 0 auto;
        }
        .tab-btn { 
            background: none; border: none; 
            display: flex; flex-direction: column; align-items: center; 
            color: var(--text-sub); font-size: 10px; font-weight: 600; cursor: pointer; 
            opacity: 0.6; transition: 0.3s;
        }
        .tab-btn.active { color: var(--primary); opacity: 1; transform: translateY(-2px); }
        .tab-btn i { font-size: 22px; margin-bottom: 4px; }

        /* Orta Ekle Butonu (Floating Action Button) */
        .tab-fab {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            width: 56px; height: 56px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 24px;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
            margin-top: -35px; border: 4px solid var(--bg-body);
            transition: 0.3s;
        }
        .tab-fab:active { transform: scale(0.9) rotate(90deg); }

        /* --- MODALLER --- */
        .modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { 
            background: var(--surface); width: 100%; max-width: 600px; 
            padding: 30px 25px 40px; 
            border-radius: 30px 30px 0 0; 
            max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; display: block; text-transform: uppercase; }
        .modern-input { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); font-size: 16px; outline: none; transition: 0.3s; }
        .modern-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); background: var(--surface); }

        .btn-primary { width: 100%; padding: 18px; background: var(--text-main); color: var(--surface); border: none; border-radius: 18px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px -5px rgba(0,0,0,0.2); }

        /* --- GİRİŞ EKRANI --- */
        #login-screen { 
            position: fixed; inset: 0; 
            background: var(--surface); z-index: 5000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; 
            background-image: radial-gradient(circle at top right, rgba(79, 70, 229, 0.1), transparent 40%), radial-gradient(circle at bottom left, rgba(236, 72, 153, 0.1), transparent 40%);
        }
        .login-card { width: 100%; max-width: 350px; text-align: center; }
        .login-logo { width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 24px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white; box-shadow: 0 20px 40px -10px rgba(79, 70, 229, 0.4); }

        #loader { position: fixed; inset: 0; background: var(--bg-body); z-index: 6000; display: none; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite cubic-bezier(0.6, 0.2, 0.4, 0.8); }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="login-screen">
        <div class="login-card">
            <div class="login-logo"><i class="fas fa-layer-group"></i></div>
            <h2 style="font-size:28px; font-weight:800; margin-bottom:10px;">Hoşgeldin.</h2>
            <p style="color:var(--text-sub); margin-bottom:40px;">Trio Operasyon Sistemi v11</p>
            <div style="position:relative; margin-bottom:20px;">
                <input type="tel" id="passwordInput" class="modern-input" placeholder="Giriş Şifresi" maxlength="4" style="text-align:center; letter-spacing:8px; font-size:24px; font-weight:800;">
            </div>
            <button class="btn-primary" onclick="checkLogin()">Sisteme Gir <i class="fas fa-arrow-right" style="margin-left:10px;"></i></button>
        </div>
    </div>

    <div class="app-container" id="mainApp">
        <header class="header">
            <div class="brand">
                <div class="logo-box"><i class="fas fa-shield-alt"></i></div>
                <div>
                    <h1>TRIO<br><span>MANAGER PRO</span></h1>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-icon-glass" onclick="exportMasterExcel()"><i class="fas fa-file-excel" style="color:var(--success)"></i></button>
                <button class="btn-icon-glass" onclick="openSettings()"><i class="fas fa-cog"></i></button>
                <button class="btn-icon-glass" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <div class="stats">
            <div class="stat-item"><span class="stat-val" style="color:var(--primary)" id="stPat">0</span><span class="stat-lbl">Hasta</span></div>
            <div class="stat-item"><span class="stat-val" style="color:var(--text-sub)" id="stDev">0</span><span class="stat-lbl">Depo</span></div>
            <div class="stat-item"><span class="stat-val" style="color:var(--warning)" id="stMaint">0</span><span class="stat-lbl">Bakım</span></div>
            <div class="stat-item"><span class="stat-val" style="color:var(--danger)" id="stUrg">0</span><span class="stat-lbl">Acil</span></div>
        </div>

        <div id="view-patient" class="view-section active">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="srcPat" class="form-input-clean" placeholder="Hasta veya cihaz ara..." onkeyup="renderData()">
            </div>
            <div id="list-patient"></div>
        </div>

        <div id="view-device" class="view-section" style="display:none;">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="srcDev" class="form-input-clean" placeholder="Barkod veya konum ara..." onkeyup="renderData()">
            </div>
            
            <div id="locationFilters" class="filter-scroll"></div>

            <div id="list-device"></div>
        </div>

        <nav class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('patient', this)">
                <i class="fas fa-user-injured"></i>Hastalar
            </button>
            
            <button class="tab-btn" onclick="openModal('new')">
                <div class="tab-fab"><i class="fas fa-plus"></i></div>
            </button>
            
            <button class="tab-btn" onclick="switchTab('device', this)">
                <i class="fas fa-server"></i>Cihazlar
            </button>
        </nav>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div style="width:40px; height:4px; background:var(--border); border-radius:10px; margin:0 auto 20px;"></div>
            <h3 id="modalTitle" style="font-size:22px; font-weight:800; margin-bottom:20px;">Kayıt İşlemi</h3>
            <input type="hidden" id="editId"><input type="hidden" id="editType">
            
            <div id="typeSelector" style="display:flex; gap:10px; margin-bottom:25px; background:var(--bg-body); padding:5px; border-radius:16px;">
                <button onclick="setType('patient')" id="btnTypePat" class="btn-act primary" style="border-radius:12px; height:45px;">Hasta</button>
                <button onclick="setType('device')" id="btnTypeDev" class="btn-act soft" style="border-radius:12px; height:45px;">Cihaz</button>
            </div>

            <div class="form-group">
                <label class="form-label">Servis / Konum</label>
                <input type="text" id="inpService" class="modern-input" placeholder="Örn: Plastik 1">
            </div>
            <div class="form-group">
                <label class="form-label">Cihaz Barkod</label>
                <input type="text" id="inpDevice" class="modern-input" placeholder="Barkod Okutun">
            </div>
            <div id="patientFields">
                <div class="form-group">
                    <label class="form-label">Hasta Adı Soyadı</label>
                    <input type="text" id="inpName" class="modern-input" placeholder="Ad Soyad">
                </div>
                <div class="form-group">
                    <label class="form-label">Pansuman Tarihi</label>
                    <input type="date" id="inpDate" class="modern-input">
                </div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:30px;">
                <button onclick="closeModal('modal')" class="btn-act soft" style="flex:1; height:55px; font-size:14px;">İptal</button>
                <button onclick="saveData()" class="btn-act primary" style="flex:2; height:55px; font-size:14px;">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div style="width:40px; height:4px; background:var(--border); border-radius:10px; margin:0 auto 20px;"></div>
            <h3>Ayarlar</h3><br>
            <button onclick="openTrash()" class="btn-primary" style="background:var(--danger); margin-bottom:20px;">
                <i class="fas fa-trash-alt"></i> Çöp Kutusu
            </button>
            <div class="form-group">
                <label class="form-label">Rapor Numarası</label>
                <input type="tel" id="adminNumber" class="modern-input" placeholder="905xxxxxxxxx">
            </div>
            <button onclick="saveSettings()" class="btn-primary">Kaydet ve Kapat</button>
        </div>
    </div>

    <div id="trashModal" class="modal-overlay">
        <div class="modal-content">
            <div style="width:40px; height:4px; background:var(--border); border-radius:10px; margin:0 auto 20px;"></div>
            <h3>Geri Dönüşüm</h3>
            <div id="trashList" style="margin-top:20px;"></div>
            <button onclick="closeModal('trashModal')" class="btn-primary" style="background:var(--bg-body); color:var(--text-main); margin-top:20px;">Kapat</button>
        </div>
    </div>

    <script>
        // --- JS KODLARI (AYNI MANTIK, SADECE AKILLI GRUPLAMA VAR) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCeemwf6KRAHl4N3wMtNx-yYIgAg5P8LEs",
            authDomain: "trio-manager.firebaseapp.com",
            projectId: "trio-manager",
            storageBucket: "trio-manager.firebasestorage.app",
            messagingSenderId: "447336966368",
            appId: "1:447336966368:web:910c838ef487c7c84c8885"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const col = "trio_records";
        let allData = [];
        let currentLocFilter = 'TÜMÜ';
        let savedNumber = localStorage.getItem('trioAdminNumber') || "";

        function checkLogin() {
            if(document.getElementById('passwordInput').value === "0000") {
                document.getElementById('login-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    startApp();
                }, 400);
            } else {
                alert("Şifre Yanlış!");
                document.getElementById('passwordInput').value = "";
            }
        }

        function startApp() {
            document.getElementById('loader').style.display = 'flex';
            if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
            const d = new Date(); d.setDate(d.getDate() + 3);
            document.getElementById('inpDate').value = d.toISOString().split('T')[0];

            db.collection(col).onSnapshot(snap => {
                allData = [];
                snap.forEach(doc => allData.push({ id: doc.id, ...doc.data() }));
                document.getElementById('loader').style.display = 'none';
                renderData();
                updateStats();
            });
        }

        function renderData() {
            const pCont = document.getElementById('list-patient');
            const dCont = document.getElementById('list-device');
            const pSrc = document.getElementById('srcPat').value.toLowerCase();
            const dSrc = document.getElementById('srcDev').value.toLowerCase();
            
            pCont.innerHTML = ""; dCont.innerHTML = "";
            const activeData = allData.filter(x => !x.isDeleted); 

            // HASTALAR
            let patients = activeData.filter(x => x.type === 'patient' && (x.name+x.service+x.device).toLowerCase().includes(pSrc));
            patients.sort((a,b) => new Date(a.dateNext) - new Date(b.dateNext));
            patients.forEach(p => {
                const diff = getDiff(p.dateNext);
                const badgeClass = diff.days <= 0 ? 'sp-red' : 'sp-green';
                
                pCont.innerHTML += `
                <div class="card">
                    <div class="card-top">
                        <div>
                            <div class="card-title">${p.name}</div>
                            <div class="card-sub"><i class="fas fa-map-marker-alt"></i> ${p.service}</div>
                        </div>
                        <span class="status-pill ${badgeClass}">${diff.text}</span>
                    </div>
                    <div class="card-sub" style="margin-bottom:10px; font-weight:600; color:var(--text-main)">
                        <i class="fas fa-barcode"></i> ${p.device}
                    </div>
                    <div class="c-actions">
                        <button class="btn-act whatsapp" onclick="sharePatient('${p.id}')">Raporla</button>
                        <button class="btn-act soft" onclick="transferToDevice('${p.id}')">Boşa Çıkar</button>
                        <button class="btn-act soft" onclick="editRecord('${p.id}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-act danger" onclick="softDelete('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });

            // CİHAZLAR & AKILLI GRUPLAMA (TRIM + UPPERCASE)
            const allDevices = activeData.filter(x => x.type === 'device' || x.type === 'maintenance');
            const locGroups = {};
            
            allDevices.forEach(d => {
                if(!d.service) return;
                const normLoc = d.service.trim().toUpperCase(); // BURASI ÖNEMLİ: BOŞLUKLARI SİLİP BÜYÜTÜR
                if(!locGroups[normLoc]) locGroups[normLoc] = 0;
                locGroups[normLoc]++;
            });

            renderLocationButtons(locGroups, allDevices.length);

            let devices = allDevices.filter(x => (x.device+x.service).toLowerCase().includes(dSrc));
            if(currentLocFilter !== 'TÜMÜ') {
                devices = devices.filter(x => x.service && x.service.trim().toUpperCase() === currentLocFilter);
            }

            devices.forEach(d => {
                const isMaint = d.type === 'maintenance';
                const statusText = isMaint ? 'BAKIMDA' : 'DEPO / BOŞ';
                const pillClass = isMaint ? 'sp-orange' : 'sp-blue';
                
                let btns = isMaint ? 
                    `<button class="btn-act soft" onclick="toggleMaintenance('${d.id}', false)">Depoya Al</button>` :
                    `<button class="btn-act whatsapp" onclick="shareDevice('${d.id}')">Paylaş</button>
                     <button class="btn-act soft" onclick="transferToPatient('${d.id}')">Hastaya</button>
                     <button class="btn-act soft" onclick="toggleMaintenance('${d.id}', true)">Bakım</button>`;

                dCont.innerHTML += `
                <div class="card">
                    <div class="card-top">
                        <div>
                            <div class="card-title" style="font-family:monospace; letter-spacing:1px;">${d.device}</div>
                            <div class="card-sub"><i class="fas fa-map-marker-alt"></i> ${d.service}</div>
                        </div>
                        <span class="status-pill ${pillClass}">${statusText}</span>
                    </div>
                    <div class="c-actions">
                        ${btns}
                        <button class="btn-act soft" onclick="editRecord('${d.id}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-act danger" onclick="softDelete('${d.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });

            if(patients.length===0) pCont.innerHTML = "<div style='text-align:center; padding:40px; color:var(--text-sub);'>Kayıt bulunamadı.</div>";
            if(devices.length===0) dCont.innerHTML = "<div style='text-align:center; padding:40px; color:var(--text-sub);'>Cihaz bulunamadı.</div>";
        }

        function renderLocationButtons(groups, total) {
            const container = document.getElementById('locationFilters');
            const sortedLocs = Object.keys(groups).sort();

            let html = `<div class="filter-chip ${currentLocFilter === 'TÜMÜ' ? 'active' : ''}" onclick="setLocFilter('TÜMÜ')">TÜMÜ <span>(${total})</span></div>`;
            
            sortedLocs.forEach(loc => {
                html += `<div class="filter-chip ${currentLocFilter === loc ? 'active' : ''}" onclick="setLocFilter('${loc}')">${loc} <span>(${groups[loc]})</span></div>`;
            });
            container.innerHTML = html;
        }

        function setLocFilter(loc) {
            currentLocFilter = loc;
            renderData();
        }

        // --- ORTAK FONKSİYONLAR (DEĞİŞMEDİ) ---
        function transferToDevice(id) {
            const newLoc = prompt("Yeni konum neresi?", "Depo");
            if(newLoc === null) return;
            db.collection(col).doc(id).update({ type: 'device', name: 'BOŞTA', service: newLoc, dateNext: firebase.firestore.FieldValue.delete() });
        }
        function transferToPatient(id) {
            const r = allData.find(x => x.id === id);
            openModal('new');
            document.getElementById('editId').value = id;
            document.getElementById('editType').value = 'patient';
            document.getElementById('inpDevice').value = r.device;
            document.getElementById('inpService').value = r.service;
            setType('patient');
            document.getElementById('modalTitle').innerText = "Cihazı Hastaya Tak";
        }
        function toggleMaintenance(id, toMaint) {
            if(confirm(toMaint ? "Cihaz bakıma gidiyor?" : "Cihaz depoya dönüyor?")) {
                db.collection(col).doc(id).update({ type: toMaint ? 'maintenance' : 'device' });
            }
        }
        function softDelete(id) { if(confirm("Çöp kutusuna taşınsın mı?")) db.collection(col).doc(id).update({ isDeleted: true }); }
        function openTrash() {
            closeModal('settingsModal');
            document.getElementById('trashModal').classList.add('open');
            const list = document.getElementById('trashList');
            list.innerHTML = "";
            const deleted = allData.filter(x => x.isDeleted);
            if(deleted.length === 0) list.innerHTML = "<p style='text-align:center; color:var(--text-sub)'>Boş.</p>";
            deleted.forEach(x => {
                list.innerHTML += `<div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${x.name || x.device}</b><br><small>${x.service}</small></div>
                    <button class="btn-act whatsapp" style="width:auto" onclick="restore('${x.id}')">Geri Al</button>
                </div>`;
            });
        }
        function restore(id) { db.collection(col).doc(id).update({ isDeleted: false }); openTrash(); }
        function exportMasterExcel() {
            const activeData = allData.filter(x => !x.isDeleted);
            let sortedData = [];
            activeData.filter(x => x.type === 'patient').forEach(x => sortedData.push({d:"HASTA", c:x.device, k:x.service, i:x.name, t:formatDate(x.dateNext)}));
            activeData.filter(x => x.type === 'device').forEach(x => sortedData.push({d:"BOŞTA", c:x.device, k:x.service, i:"-", t:"-"}));
            activeData.filter(x => x.type === 'maintenance').forEach(x => sortedData.push({d:"BAKIMDA", c:x.device, k:x.service, i:"-", t:"-"}));
            let csv = "\uFEFFDURUM;CIHAZ KODU;SERVIS/KONUM;HASTA ADI;PANSUMAN TARIHI\n";
            sortedData.forEach(r => csv += `${r.d};"${r.c}";"${r.k}";"${r.i}";${r.t}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Trio_Rapor.csv`;
            link.click();
        }
        function saveData() {
            const id = document.getElementById('editId').value;
            const type = document.getElementById('editType').value;
            const s = document.getElementById('inpService').value;
            const d = document.getElementById('inpDevice').value;
            let data = { type, service:s, device:d, isDeleted: false };
            if(type === 'patient') {
                data.name = document.getElementById('inpName').value;
                data.dateNext = document.getElementById('inpDate').value;
                if(!data.name || !s) return alert("Eksik bilgi!");
            } else data.name = "BOŞTA";
            if(id) db.collection(col).doc(id).update(data); else { data.createdAt = Date.now(); db.collection(col).add(data); }
            closeModal('modal');
        }
        function editRecord(id) {
            const r = allData.find(x => x.id === id);
            openModal('new');
            document.getElementById('editId').value = id;
            document.getElementById('modalTitle').innerText = "Düzenle";
            setType(r.type === 'maintenance' ? 'device' : r.type);
            document.getElementById('inpService').value = r.service;
            document.getElementById('inpDevice').value = r.device;
            if(r.type === 'patient') { document.getElementById('inpName').value = r.name; document.getElementById('inpDate').value = r.dateNext; }
        }
        function sharePatient(id) { const p=allData.find(x=>x.id===id); sendWP(`*HASTA:* ${p.name}\n*KONUM:* ${p.service}\n*CİHAZ:* ${p.device}\n*TARİH:* ${formatDate(p.dateNext)}`); }
        function shareDevice(id) { const d=allData.find(x=>x.id===id); sendWP(`*BOŞ CİHAZ*\n*KOD:* ${d.device}\n*KONUM:* ${d.service}`); }
        function sendWP(txt) { window.open(savedNumber.length>5 ? `https://api.whatsapp.com/send?phone=${savedNumber}&text=${encodeURIComponent(txt)}` : `https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank'); }
        function setType(t) { 
            document.getElementById('editType').value=t; 
            const isP = t==='patient'; 
            document.getElementById('patientFields').style.display = isP ? 'block' : 'none';
            
            const btnP = document.getElementById('btnTypePat');
            const btnD = document.getElementById('btnTypeDev');
            
            if(isP) { btnP.className="btn-act primary"; btnD.className="btn-act soft"; }
            else { btnP.className="btn-act soft"; btnD.className="btn-act primary"; }
        }
        function openModal(mode) { 
            document.getElementById('modal').classList.add('open'); 
            if(mode==='new') { 
                document.getElementById('modalTitle').innerText="Yeni Kayıt"; 
                document.getElementById('editId').value=""; 
                document.getElementById('inpName').value=""; 
                document.getElementById('inpService').value=""; 
                document.getElementById('inpDevice').value=""; 
                setType('patient'); 
            } 
        }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function openSettings() { document.getElementById('settingsModal').classList.add('open'); document.getElementById('adminNumber').value = savedNumber; }
        function saveSettings() { savedNumber = document.getElementById('adminNumber').value.replace(/\D/g,''); localStorage.setItem('trioAdminNumber', savedNumber); closeModal('settingsModal'); }
        function switchTab(v, b) { 
            document.querySelectorAll('.view-section').forEach(x=>x.style.display='none'); 
            document.getElementById('view-'+v).style.display='block'; 
            document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); 
            if(b) b.classList.add('active'); 
        }
        function getDiff(d) { const df=Math.ceil((new Date(d)-new Date().setHours(0,0,0,0))/86400000); if(df===0)return{days:0,text:'BUGÜN'}; if(df===1)return{days:1,text:'YARIN'}; if(df<0)return{days:-1,text:'GECİKTİ'}; return{days:df,text:df+' GÜN'}; }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('tr-TR') : "-"; }
        function updateStats() { const active = allData.filter(x => !x.isDeleted); document.getElementById('stPat').innerText=active.filter(x=>x.type==='patient').length; document.getElementById('stDev').innerText=active.filter(x=>x.type==='device').length; document.getElementById('stMaint').innerText=active.filter(x=>x.type==='maintenance').length; document.getElementById('stUrg').innerText=active.filter(x=>x.type==='patient'&&getDiff(x.dateNext).days<=0).length; }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); }
    </script>
</body>
</html>

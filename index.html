<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Trio Manager Elite</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="login-screen">
        <div class="logo-box" style="width:100px; height:100px; font-size:40px; margin-bottom:40px; border-radius:30px;"><i class="fas fa-fingerprint"></i></div>
        <h2 style="font-size:32px; font-weight:800; margin-bottom:10px; text-align:center;">Trio Manager</h2>
        <p style="color:var(--text-sub); margin-bottom:40px;">Güvenli Yönetim Paneli</p>
        <input type="tel" id="passwordInput" class="lux-input" placeholder="PASSCODE" maxlength="4" style="text-align:center; letter-spacing:10px; font-size:24px;">
        <button class="lux-btn" onclick="checkLogin()">GİRİŞ YAP</button>
    </div>

    <div class="app-container" id="mainApp">
        <header class="header">
            <div class="brand">
                <div class="logo-box"><i class="fas fa-layer-group"></i></div>
                <div><h1>TRIO<br><span>MANAGER ELITE</span></h1></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-glass" onclick="openNotifications()">
                    <i class="fas fa-bell"></i>
                    <div id="notifBadge" class="badge-dot"></div>
                </button>
                <button class="btn-glass" onclick="openSettings()"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-num" style="color:var(--primary)" id="stPat">0</span>
                <span class="stat-name">HASTA</span>
            </div>
            <div class="stat-card">
                <span class="stat-num" style="color:#64748b" id="stDev">0</span>
                <span class="stat-name">DEPO</span>
            </div>
            <div class="stat-card">
                <span class="stat-num" style="color:#f59e0b" id="stMaint">0</span>
                <span class="stat-name">BAKIM</span>
            </div>
            <div class="stat-card">
                <span class="stat-num" style="color:#ef4444" id="stUrg">0</span>
                <span class="stat-name">ACİL</span>
            </div>
        </div>

        <div id="view-patient" class="view-section active">
            <div class="search-bar">
                <i class="fas fa-search" style="color:var(--text-sub); margin-right:10px;"></i>
                <input type="text" id="srcPat" class="search-input" placeholder="Hasta, Oda veya Cihaz Ara..." onkeyup="renderData()">
            </div>
            <div id="list-patient"></div>
        </div>

        <div id="view-device" class="view-section" style="display:none;">
            <div class="search-bar">
                <i class="fas fa-search" style="color:var(--text-sub); margin-right:10px;"></i>
                <input type="text" id="srcDev" class="search-input" placeholder="Barkod veya Konum Ara..." onkeyup="renderData()">
            </div>
            <div id="locationFilters" class="filter-scroll"></div>
            <div id="list-device"></div>
        </div>

        <!-- NEW ANALYTICS VIEW -->
        <div id="view-analytics" class="view-section" style="display:none;">
            <div class="search-bar">
                <i class="fas fa-calendar-alt" style="color:var(--text-sub); margin-right:10px;"></i>
                <input type="month" id="analyticsDate" class="search-input" onchange="loadAnalytics()" style="font-family:monospace;">
                <button onclick="resetMonthlyAnalytics()" style="width:40px;height:40px;background:none;border:none;color:#ef4444;cursor:pointer;"><i class="fas fa-trash"></i></button>
            </div>
            
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="stat-card">
                     <span class="stat-num" id="an-total-recs" style="color:var(--text-main)">0</span>
                     <span class="stat-name">TOPLAM İŞLEM</span>
                </div>
                 <div class="stat-card">
                     <span class="stat-num" id="an-patients-added" style="color:var(--primary)">0</span>
                     <span class="stat-name">YENİ HASTA</span>
                </div>
            </div>

            <h3 style="font-size:14px; font-weight:800; margin:20px 0 10px; color:var(--text-sub); text-transform:uppercase;">İŞLEM GEÇMİŞİ</h3>
            <div id="analytics-list">
                <div style="text-align:center; padding:30px; opacity:0.5; font-size:13px;">Veri yüklemek için tarih seçin.</div>
            </div>
        </div>

        <div class="dock">
            <button class="dock-btn active" onclick="switchTab('patient', this)"><i class="fas fa-user-injured"></i></button>
            <button class="dock-fab" onclick="openModal('new')"><i class="fas fa-plus"></i></button>
            <button class="dock-btn" onclick="switchTab('device', this)"><i class="fas fa-server"></i></button>
            <button class="dock-btn" onclick="switchTab('analytics', this)" style="color: #6366f1;"><i class="fas fa-chart-pie"></i></button>
        </div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-handle"></div>
            <h3 id="modalTitle" style="font-size:24px; font-weight:800; margin-bottom:25px;">Kayıt İşlemi</h3>
            <input type="hidden" id="editId"><input type="hidden" id="editType">
            
            <div id="typeSelector" style="display:flex; gap:10px; margin-bottom:20px; background:var(--bg-body); padding:6px; border-radius:18px;">
                <button onclick="setType('patient')" id="btnTypePat" class="act-btn btn-brand" style="flex:1; height:48px;">HASTA</button>
                <button onclick="setType('device')" id="btnTypeDev" class="act-btn btn-soft" style="flex:1; height:48px;">CİHAZ</button>
            </div>

            <input type="text" id="inpService" class="lux-input" placeholder="Servis / Konum">
            <input type="text" id="inpDevice" class="lux-input" placeholder="Cihaz Barkod">
            <div id="patientFields">
                <input type="text" id="inpName" class="lux-input" placeholder="Hasta Adı Soyadı">
                <input type="date" id="inpDate" class="lux-input">
            </div>
            <div style="display:flex; gap:15px; margin-top:20px;">
                <button onclick="closeModal('modal')" class="lux-btn" style="background:var(--bg-body); color:var(--text-main); flex:1">İptal</button>
                <button onclick="saveData()" class="lux-btn" style="flex:2">KAYDET</button>
            </div>
        </div>
    </div>

    <div id="notifModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-handle"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="font-size:22px; font-weight:800;">Bildirimler</h3>
                <button onclick="clearNotifications()" style="background:none; border:none; color:var(--accent); font-weight:700; font-size:13px;">Temizle</button>
            </div>
            <div id="notifList" style="max-height:60vh; overflow-y:auto;"></div>
            <button onclick="closeModal('notifModal')" class="lux-btn" style="margin-top:20px; background:var(--bg-body); color:var(--text-main)">Kapat</button>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-handle"></div>
            <h3 style="font-size:22px; font-weight:800; margin-bottom:20px;">Sistem Ayarları</h3>
            <button onclick="window.location.reload(true)" class="lux-btn" style="background:var(--primary); margin-bottom:15px;"><i class="fas fa-sync"></i> SİSTEMİ YENİLE</button>
            <button onclick="openTrash()" class="lux-btn" style="background:var(--accent); margin-bottom:25px;"><i class="fas fa-trash-alt"></i> ÇÖP KUTUSU</button>
            <button onclick="toggleTheme()" class="lux-btn" style="background:var(--text-main); margin-bottom:25px;"><i class="fas fa-moon"></i> GECE MODU</button>
            
            <label style="font-size:12px; font-weight:700; color:var(--text-sub); margin-bottom:10px; display:block;">RAPOR NUMARASI</label>
            <input type="tel" id="adminNumber" class="lux-input" placeholder="905xxxxxxxxx">
            
            <button onclick="exportMasterExcel()" class="lux-btn" style="background:#10b981; margin-bottom:15px;"><i class="fas fa-file-excel"></i> Excel İndir</button>
            <button onclick="findDuplicates()" class="lux-btn" style="background:#f59e0b; margin-bottom:15px;"><i class="fas fa-clone"></i> MÜKERRER KAYIT KONTROLÜ</button>
            <button onclick="saveSettings()" class="lux-btn" style="background:var(--text-main)">KAYDET</button>
            <button onclick="logout()" class="lux-btn" style="background:#ef4444; margin-top:10px;"><i class="fas fa-sign-out-alt"></i> GÜVENLİ ÇIKIŞ</button>
            <button onclick="closeModal('settingsModal')" class="lux-btn" style="background:transparent; color:var(--text-sub); margin-top:10px;">Vazgeç</button>
        </div>
    </div>

    <div id="trashModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-handle"></div>
            <h3>Geri Dönüşüm</h3>
            <div id="trashList" style="margin-top:20px;"></div>
            <button onclick="closeModal('trashModal')" class="lux-btn" style="margin-top:20px; background:var(--bg-body); color:var(--text-main)">Kapat</button>
        </div>
    </div>

    <div id="dateModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-handle"></div>
            <h3 style="font-size:20px; font-weight:800; margin-bottom:20px; text-align:center;">Sonraki Pansuman?</h3>
            <input type="hidden" id="dateRecordId">
            
            <div class="date-actions">
                <button class="quick-btn" onclick="setQuickDate(1)">YARIN</button>
                <button class="quick-btn" onclick="setQuickDate(2)">2 GÜN</button>
                <button class="quick-btn active" onclick="setQuickDate(3)">3 GÜN</button>
            </div>

            <input type="date" id="dressingDateInput" class="big-date-input">
            
            <button onclick="saveDressingDate()" class="lux-btn" style="background:#8b5cf6">KAYDET</button>
            <button onclick="closeModal('dateModal')" class="lux-btn" style="background:transparent; color:var(--text-sub); margin-top:10px;">Vazgeç</button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/services/analytics.js"></script>
    <script src="js/app.js"></script>

</body>
</html>

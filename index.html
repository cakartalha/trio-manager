<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trio Manager Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #2563eb; --whatsapp: #25D366; --asset: #7c3aed; --maint: #f97316; --bg-body: #f1f5f9; --bg-card: #ffffff; --text-main: #1e293b; --text-sub: #64748b; --border: #e2e8f0; --danger: #ef4444; --success: #10b981; --radius: 16px; }
        body.dark-mode { --primary: #3b82f6; --asset: #a78bfa; --maint: #fdba74; --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-sub: #94a3b8; --border: #334155; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); padding-bottom: 90px; padding-top: 15px; transition: 0.3s; }
        .app-container { max-width: 600px; margin: 0 auto; padding: 0 15px; display: none; }
        
        /* Gƒ∞Rƒ∞≈û EKRANI */
        #login-screen { position: fixed; inset: 0; background: var(--bg-body); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: var(--bg-card); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
        .pass-input { width: 100%; padding: 15px; font-size: 24px; text-align: center; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 20px; letter-spacing: 5px; outline: none; background: var(--bg-body); color: var(--text-main); }
        .btn-login { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }

        /* HEADER & GENEL */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .brand { display: flex; align-items: center; gap: 10px; }
        .brand i { font-size: 24px; color: var(--primary); background: #e0e7ff; padding: 8px; border-radius: 10px; }
        .brand h1 { font-size: 18px; font-weight: 800; line-height: 1.2; }
        .brand h1 span { font-size: 11px; font-weight: 500; color: var(--text-sub); display: block; }
        .head-actions { display: flex; gap: 8px; }
        .btn-icon { background: var(--bg-card); border: 1px solid var(--border); width: 40px; height: 40px; border-radius: 12px; color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }

        /* ƒ∞STATƒ∞STƒ∞K */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .stat-item { background: var(--bg-card); padding: 10px 5px; border-radius: var(--radius); text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 18px; font-weight: 800; color: var(--primary); display: block; }
        .stat-lbl { font-size: 9px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }

        /* KARTLAR */
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); position: relative; }
        .card.patient { border-left: 5px solid var(--primary); }
        .card.device { border-left: 5px solid var(--asset); }
        .card.maintenance { border-left: 5px solid var(--maint); }
        .c-actions { display: flex; gap: 8px; border-top: 1px solid var(--border); padding-top: 10px; margin-top: 10px; overflow-x: auto; }
        .btn-act { flex: 1; height: 38px; border-radius: 10px; border: none; font-size: 11px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 0 10px; white-space: nowrap; }
        
        /* MODALLER */
        .modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 600px; padding: 25px; border-radius: 24px 24px 0 0; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .form-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); margin-bottom: 15px; outline: none; }
        
        /* TAB BAR */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        .tab-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 10px; font-weight: 600; cursor: pointer; }
        .tab-btn.active { color: var(--primary); }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: var(--bg-body); z-index: 2100; display: none; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Fƒ∞LTRE BUTONLARI */
        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 12px; scrollbar-width: none; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-chip { 
            padding: 8px 16px; 
            border-radius: 20px; 
            border: 1px solid var(--border); 
            background: var(--bg-card); 
            color: var(--text-sub); 
            font-size: 12px; 
            font-weight: 600; 
            white-space: nowrap; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .filter-chip.active { background: var(--asset); color: white; border-color: var(--asset); }
        .filter-chip span { opacity: 0.7; font-size: 10px; margin-left: 4px; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="margin-bottom:20px;">TRIO Gƒ∞Rƒ∞≈û</h2>
            <input type="tel" id="passwordInput" class="pass-input" placeholder="****" maxlength="4">
            <button class="btn-login" onclick="checkLogin()">Gƒ∞Rƒ∞≈û</button>
        </div>
    </div>

    <div class="app-container" id="mainApp">
        <header class="header">
            <div class="brand"><i class="fas fa-shield-alt"></i><h1>TRIO PRO<br><span>V10 SMART</span></h1></div>
            <div class="head-actions">
                <button class="btn-icon" onclick="exportMasterExcel()" style="color:var(--success)" title="Excel Rapor"><i class="fas fa-file-excel"></i></button>
                <button class="btn-icon" onclick="openSettings()" title="Ayarlar"><i class="fas fa-cog"></i></button>
                <button class="btn-icon" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <div class="stats">
            <div class="stat-item"><span class="stat-val" id="stPat">0</span><span class="stat-lbl">Hasta</span></div>
            <div class="stat-item"><span class="stat-val" id="stDev" style="color:var(--asset)">0</span><span class="stat-lbl">Depo</span></div>
            <div class="stat-item"><span class="stat-val" id="stMaint" style="color:var(--maint)">0</span><span class="stat-lbl">Bakƒ±m</span></div>
            <div class="stat-item"><span class="stat-val" id="stUrg" style="color:var(--danger)">0</span><span class="stat-lbl">Acil</span></div>
        </div>

        <div id="view-patient" class="view-section active">
            <input type="text" id="srcPat" class="form-input" placeholder="Hasta, Oda veya Cihaz Ara..." onkeyup="renderData()">
            <div id="list-patient"></div>
        </div>

        <div id="view-device" class="view-section">
            <input type="text" id="srcDev" class="form-input" placeholder="Barkod veya Konum Ara..." onkeyup="renderData()">
            
            <div id="locationFilters" class="filter-scroll"></div>

            <div id="list-device"></div>
        </div>

        <nav class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('patient', this)"><i class="fas fa-user-injured"></i><br>Hastalar</button>
            <button class="tab-btn" onclick="switchTab('device', this)"><i class="fas fa-server"></i><br>Cihazlar</button>
            <button class="tab-btn" onclick="openModal('new')"><i class="fas fa-plus-circle" style="font-size:22px"></i><br>Ekle</button>
        </nav>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">Kayƒ±t ƒ∞≈ülemi</h3><br>
            <input type="hidden" id="editId"><input type="hidden" id="editType">
            
            <div id="typeSelector" style="display:flex; gap:10px; margin-bottom:15px;">
                <button onclick="setType('patient')" id="btnTypePat" class="btn-act" style="background:var(--primary); color:white;">Hasta</button>
                <button onclick="setType('device')" id="btnTypeDev" class="btn-act" style="background:var(--bg-body); color:var(--text-sub);">Cihaz</button>
            </div>

            <input type="text" id="inpService" class="form-input" placeholder="Servis / Konum">
            <input type="text" id="inpDevice" class="form-input" placeholder="Cihaz Barkod">
            <div id="patientFields">
                <input type="text" id="inpName" class="form-input" placeholder="Hasta Adƒ± Soyadƒ±">
                <input type="date" id="inpDate" class="form-input">
            </div>
            <button onclick="saveData()" class="btn-login">Kaydet</button>
            <button onclick="closeModal('modal')" style="width:100%; margin-top:15px; background:none; border:none; color:var(--text-sub)">ƒ∞ptal</button>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚öôÔ∏è Ayarlar</h3><hr style="border:0; border-top:1px solid var(--border); margin:15px 0;"><br>
            <button onclick="openTrash()" class="btn-login" style="background:var(--danger); margin-bottom:20px;">
                <i class="fas fa-trash-alt"></i> √á√∂p Kutusunu A√ß
            </button>
            <label style="font-size:12px; font-weight:bold;">WhatsApp Rapor Numarasƒ± (905...)</label>
            <input type="tel" id="adminNumber" class="form-input" placeholder="90532XXXXXXX">
            <button onclick="saveSettings()" class="btn-login">Kaydet</button>
            <button onclick="closeModal('settingsModal')" style="width:100%; margin-top:15px; background:none; border:none; color:var(--text-sub)">Kapat</button>
        </div>
    </div>

    <div id="trashModal" class="modal-overlay">
        <div class="modal-content">
            <h3>üóëÔ∏è Geri D√∂n√º≈ü√ºm Kutusu</h3>
            <p style="font-size:12px; color:var(--text-sub); margin-bottom:15px;">Buradaki kayƒ±tlar ana listede g√∂r√ºnmez.</p>
            <div id="trashList" style="max-height:50vh; overflow-y:auto; margin-bottom:15px;"></div>
            <button onclick="closeModal('trashModal')" class="btn-login" style="background:var(--text-sub)">Kapat</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCeemwf6KRAHl4N3wMtNx-yYIgAg5P8LEs",
            authDomain: "trio-manager.firebaseapp.com",
            projectId: "trio-manager",
            storageBucket: "trio-manager.firebasestorage.app",
            messagingSenderId: "447336966368",
            appId: "1:447336966368:web:910c838ef487c7c84c8885"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const col = "trio_records";
        let allData = [];
        let currentLocFilter = 'T√úM√ú';
        let savedNumber = localStorage.getItem('trioAdminNumber') || "";

        function checkLogin() {
            if(document.getElementById('passwordInput').value === "0000") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                startApp();
            } else {
                alert("Hatalƒ± ≈ûifre!");
                document.getElementById('passwordInput').value = "";
            }
        }

        function startApp() {
            document.getElementById('loader').style.display = 'flex';
            if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
            const d = new Date(); d.setDate(d.getDate() + 3);
            document.getElementById('inpDate').value = d.toISOString().split('T')[0];

            db.collection(col).onSnapshot(snap => {
                allData = [];
                snap.forEach(doc => allData.push({ id: doc.id, ...doc.data() }));
                document.getElementById('loader').style.display = 'none';
                renderData();
                updateStats();
            }, err => { console.error(err); document.getElementById('loader').style.display = 'none'; });
        }

        function renderData() {
            const pCont = document.getElementById('list-patient');
            const dCont = document.getElementById('list-device');
            const pSrc = document.getElementById('srcPat').value.toLowerCase();
            const dSrc = document.getElementById('srcDev').value.toLowerCase();
            
            pCont.innerHTML = ""; dCont.innerHTML = "";
            const activeData = allData.filter(x => !x.isDeleted); 

            // HASTALAR
            let patients = activeData.filter(x => x.type === 'patient' && (x.name+x.service+x.device).toLowerCase().includes(pSrc));
            patients.sort((a,b) => new Date(a.dateNext) - new Date(b.dateNext));
            patients.forEach(p => {
                const diff = getDiff(p.dateNext);
                pCont.innerHTML += `
                <div class="card patient">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${p.name}</b>
                        <span style="font-size:10px; background:${diff.days<=0?'var(--danger)':'var(--success)'}; color:white; padding:2px 6px; border-radius:4px;">${diff.text}</span>
                    </div>
                    <div style="font-size:12px; color:var(--text-sub); margin:5px 0;">
                        <i class="fas fa-map-marker-alt"></i> ${p.service} &nbsp;|&nbsp; <i class="fas fa-barcode"></i> ${p.device}
                    </div>
                    <div class="c-actions">
                        <button class="btn-act" style="background:#dcfce7; color:#15803d" onclick="sharePatient('${p.id}')"><i class="fab fa-whatsapp"></i></button>
                        <button class="btn-act" style="background:#f3e8ff; color:#6b21a8" onclick="transferToDevice('${p.id}')">BO≈ûA √áIKAR</button>
                        <button class="btn-act" style="background:var(--bg-body); color:var(--text-sub)" onclick="editRecord('${p.id}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-act" style="background:#fee2e2; color:#b91c1c" onclick="softDelete('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });

            // Cƒ∞HAZLAR VE Fƒ∞LTRE MANTIƒûI
            const allDevices = activeData.filter(x => x.type === 'device' || x.type === 'maintenance');
            
            // KONUMLARI STANDARTLA≈ûTIR (Trim + Uppercase ile grupla)
            // { "ASYAMED": count, "DEPO": count }
            const locGroups = {};
            allDevices.forEach(d => {
                if(!d.service) return;
                const normLoc = d.service.trim().toUpperCase(); // B√úY√úK HARF + BO≈ûLUK TEMƒ∞ZLEME
                if(!locGroups[normLoc]) locGroups[normLoc] = 0;
                locGroups[normLoc]++;
            });

            // Filtre Butonlarƒ±nƒ± √áiz
            renderLocationButtons(locGroups, allDevices.length);

            // Cihazlarƒ± Listele
            let devices = allDevices.filter(x => (x.device+x.service).toLowerCase().includes(dSrc));
            
            // Filtre Se√ßiliyse Uygula (Standartla≈ütƒ±rƒ±lmƒ±≈ü isme g√∂re)
            if(currentLocFilter !== 'T√úM√ú') {
                devices = devices.filter(x => x.service && x.service.trim().toUpperCase() === currentLocFilter);
            }

            devices.forEach(d => {
                const isMaint = d.type === 'maintenance';
                const styleClass = isMaint ? 'maintenance' : 'device';
                const statusText = isMaint ? 'BAKIMDA' : 'DEPO / BO≈û';
                
                let btns = isMaint ? 
                    `<button class="btn-act" style="background:#f3e8ff; color:#6b21a8" onclick="toggleMaintenance('${d.id}', false)">DEPOYA AL</button>` :
                    `<button class="btn-act" style="background:#dcfce7; color:#15803d" onclick="shareDevice('${d.id}')"><i class="fab fa-whatsapp"></i></button>
                     <button class="btn-act" style="background:#f3e8ff; color:#6b21a8" onclick="transferToPatient('${d.id}')">HASTAYA</button>
                     <button class="btn-act" style="background:#ffedd5; color:#c2410c" onclick="toggleMaintenance('${d.id}', true)">BAKIM</button>`;

                dCont.innerHTML += `
                <div class="card ${styleClass}">
                    <div style="display:flex; justify-content:space-between;">
                        <b style="color:${isMaint?'var(--maint)':'var(--asset)'}">${d.device}</b>
                        <span style="font-size:10px; background:${isMaint?'var(--maint)':'var(--asset)'}; color:white; padding:2px 6px; border-radius:4px;">${statusText}</span>
                    </div>
                    <div style="font-size:12px; color:var(--text-sub); margin:5px 0;">
                        <i class="fas fa-map-marker-alt"></i> ${d.service}
                    </div>
                    <div class="c-actions">
                        ${btns}
                        <button class="btn-act" style="background:var(--bg-body); color:var(--text-sub)" onclick="editRecord('${d.id}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-act" style="background:#fee2e2; color:#b91c1c" onclick="softDelete('${d.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
            
            if(patients.length===0) pCont.innerHTML = "<div style='text-align:center; color:gray; padding:20px;'>Kayƒ±t yok.</div>";
            if(devices.length===0) dCont.innerHTML = "<div style='text-align:center; color:gray; padding:20px;'>Cihaz yok.</div>";
        }

        // --- SAYA√áLI KONUM BUTONLARI (STANDARTLA≈ûTIRILMI≈û) ---
        function renderLocationButtons(groups, totalCount) {
            const container = document.getElementById('locationFilters');
            
            // Gruplarƒ± isme g√∂re sƒ±rala
            const sortedLocs = Object.keys(groups).sort();

            let html = `<button class="filter-chip ${currentLocFilter === 'T√úM√ú' ? 'active' : ''}" onclick="setLocFilter('T√úM√ú')">T√úM√ú <span>(${totalCount})</span></button>`;
            
            sortedLocs.forEach(locName => {
                html += `<button class="filter-chip ${currentLocFilter === locName ? 'active' : ''}" onclick="setLocFilter('${locName}')">${locName} <span>(${groups[locName]})</span></button>`;
            });
            container.innerHTML = html;
        }

        function setLocFilter(loc) {
            currentLocFilter = loc;
            renderData();
        }

        function transferToDevice(id) {
            const newLoc = prompt("Cihaz hangi servise/konuma bƒ±rakƒ±lƒ±yor?", "Depo");
            if(newLoc === null) return;
            db.collection(col).doc(id).update({ type: 'device', name: 'BO≈ûTA', service: newLoc, dateNext: firebase.firestore.FieldValue.delete() });
        }
        function transferToPatient(id) {
            const r = allData.find(x => x.id === id);
            openModal('new');
            document.getElementById('editId').value = id;
            document.getElementById('editType').value = 'patient';
            document.getElementById('inpDevice').value = r.device;
            document.getElementById('inpService').value = r.service;
            setType('patient');
            document.getElementById('modalTitle').innerText = "Cihazƒ± Hastaya Tak";
        }
        function toggleMaintenance(id, toMaint) {
            if(confirm(toMaint ? "Cihaz bakƒ±ma gidiyor?" : "Cihaz depoya d√∂n√ºyor?")) {
                db.collection(col).doc(id).update({ type: toMaint ? 'maintenance' : 'device' });
            }
        }
        function softDelete(id) { if(confirm("Bu kayƒ±t √ß√∂p kutusuna ta≈üƒ±nsƒ±n mƒ±?")) db.collection(col).doc(id).update({ isDeleted: true }); }
        function openTrash() {
            closeModal('settingsModal');
            document.getElementById('trashModal').classList.add('open');
            const list = document.getElementById('trashList');
            list.innerHTML = "";
            const deleted = allData.filter(x => x.isDeleted);
            if(deleted.length === 0) list.innerHTML = "<div style='text-align:center; padding:20px;'>√á√∂p kutusu bo≈ü.</div>";
            deleted.forEach(x => {
                let info = x.type === 'patient' ? `${x.name} (${x.device})` : `${x.device} (Depo/Bakƒ±m)`;
                list.innerHTML += `
                <div class="card" style="border-left:3px solid var(--text-sub);">
                    <div style="font-size:13px; font-weight:bold;">${info}</div>
                    <div class="c-actions">
                        <button class="btn-act" style="background:var(--success); color:white" onclick="restore('${x.id}')">GERƒ∞ Y√úKLE</button>
                        <button class="btn-act" style="background:var(--danger); color:white" onclick="hardDelete('${x.id}')">KALICI Sƒ∞L</button>
                    </div>
                </div>`;
            });
        }
        function restore(id) { db.collection(col).doc(id).update({ isDeleted: false }); openTrash(); }
        function hardDelete(id) { if(confirm("GERƒ∞ D√ñN√ú≈û√ú YOK! Tamamen silinsin mi?")) { db.collection(col).doc(id).delete(); openTrash(); } }
        function exportMasterExcel() {
            const activeData = allData.filter(x => !x.isDeleted);
            let sortedData = [];
            activeData.filter(x => x.type === 'patient').forEach(x => sortedData.push({d:"HASTA", c:x.device, k:x.service, i:x.name, t:formatDate(x.dateNext)}));
            activeData.filter(x => x.type === 'device').forEach(x => sortedData.push({d:"BO≈ûTA", c:x.device, k:x.service, i:"-", t:"-"}));
            activeData.filter(x => x.type === 'maintenance').forEach(x => sortedData.push({d:"BAKIMDA", c:x.device, k:x.service, i:"-", t:"-"}));
            let csv = "\uFEFFDURUM;CIHAZ KODU;SERVIS/KONUM;HASTA ADI;PANSUMAN TARIHI\n";
            sortedData.forEach(r => csv += `${r.d};"${r.c}";"${r.k}";"${r.i}";${r.t}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Trio_Rapor_${new Date().toLocaleDateString('tr-TR').replace(/\./g,'_')}.csv`;
            link.click();
        }
        function saveData() {
            const id = document.getElementById('editId').value;
            const type = document.getElementById('editType').value;
            const s = document.getElementById('inpService').value;
            const d = document.getElementById('inpDevice').value;
            let data = { type, service:s, device:d, isDeleted: false };
            if(type === 'patient') {
                data.name = document.getElementById('inpName').value;
                data.dateNext = document.getElementById('inpDate').value;
                if(!data.name || !s) return alert("ƒ∞sim ve Servis zorunludur!");
            } else data.name = "BO≈ûTA";
            if(id) db.collection(col).doc(id).update(data); else { data.createdAt = Date.now(); db.collection(col).add(data); }
            closeModal('modal');
        }
        function editRecord(id) {
            const r = allData.find(x => x.id === id);
            openModal('new');
            document.getElementById('editId').value = id;
            document.getElementById('modalTitle').innerText = "D√ºzenle";
            setType(r.type === 'maintenance' ? 'device' : r.type);
            document.getElementById('inpService').value = r.service;
            document.getElementById('inpDevice').value = r.device;
            if(r.type === 'patient') { document.getElementById('inpName').value = r.name; document.getElementById('inpDate').value = r.dateNext; }
        }
        function sharePatient(id) { const p=allData.find(x=>x.id===id); sendWP(`*HASTA:* ${p.name}\n*KONUM:* ${p.service}\n*Cƒ∞HAZ:* ${p.device}\n*TARƒ∞H:* ${formatDate(p.dateNext)}`); }
        function shareDevice(id) { const d=allData.find(x=>x.id===id); sendWP(`*BO≈û Cƒ∞HAZ*\n*KOD:* ${d.device}\n*KONUM:* ${d.service}`); }
        function sendWP(txt) { window.open(savedNumber.length>5 ? `https://api.whatsapp.com/send?phone=${savedNumber}&text=${encodeURIComponent(txt)}` : `https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank'); }
        function setType(t) { document.getElementById('editType').value=t; const isP=t==='patient'; document.getElementById('patientFields').style.display=isP?'block':'none'; document.getElementById('btnTypePat').style.background=isP?'var(--primary)':'var(--bg-body)'; document.getElementById('btnTypePat').style.color=isP?'white':'var(--text-sub)'; document.getElementById('btnTypeDev').style.background=!isP?'var(--asset)':'var(--bg-body)'; document.getElementById('btnTypeDev').style.color=!isP?'white':'var(--text-sub)'; }
        function openModal(mode) { document.getElementById('modal').classList.add('open'); if(mode==='new') { document.getElementById('modalTitle').innerText="Yeni Kayƒ±t"; document.getElementById('editId').value=""; document.getElementById('inpName').value=""; document.getElementById('inpService').value=""; document.getElementById('inpDevice').value=""; setType('patient'); } }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function openSettings() { document.getElementById('settingsModal').classList.add('open'); document.getElementById('adminNumber').value = savedNumber; }
        function saveSettings() { savedNumber = document.getElementById('adminNumber').value.replace(/\D/g,''); localStorage.setItem('trioAdminNumber', savedNumber); closeModal('settingsModal'); }
        function switchTab(v, b) { document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }
        function getDiff(d) { const df=Math.ceil((new Date(d)-new Date().setHours(0,0,0,0))/86400000); if(df===0)return{days:0,text:'BUG√úN'}; if(df===1)return{days:1,text:'YARIN'}; if(df<0)return{days:-1,text:'GECƒ∞KTƒ∞'}; return{days:df,text:df+' G√úN'}; }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('tr-TR') : "-"; }
        function updateStats() { const active = allData.filter(x => !x.isDeleted); document.getElementById('stPat').innerText=active.filter(x=>x.type==='patient').length; document.getElementById('stDev').innerText=active.filter(x=>x.type==='device').length; document.getElementById('stMaint').innerText=active.filter(x=>x.type==='maintenance').length; document.getElementById('stUrg').innerText=active.filter(x=>x.type==='patient'&&getDiff(x.dateNext).days<=0).length; }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); }
    </script>
</body>
</html>
